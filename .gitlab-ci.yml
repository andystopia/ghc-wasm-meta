variables:
  DOCKER_REV: 572353e0644044fe3a5465bba4342a9a0b0eb60e
  GIT_DEPTH: 1
  GIT_STRATEGY: clone

.x86_64-linux-alpine:
  tags:
    - x86_64-linux
  image: registry.gitlab.haskell.org/ghc/ci-images/x86_64-linux-alpine3_12:$DOCKER_REV
  before_script:
    - sudo chown ghc:ghc -R .
  script:
    - |
      PREFIX=/tmp/.ghc-wasm ./setup.sh
      . /tmp/.ghc-wasm/env

      pushd "$(mktemp -d)"
      echo "import System.Environment.Blank" >> hello.hs
      echo 'main = print =<< getArgs' >> hello.hs
      wasm32-wasi-ghc hello.hs -o hello.wasm
      $CROSS_EMULATOR ./hello.wasm "114 514" 233
      wasm-run ./hello.wasm "114 514" 233
      popd

x86_64-linux-alpine-gmp:
  extends: .x86_64-linux-alpine
  variables:
    FLAVOUR: gmp

x86_64-linux-alpine-native:
  extends: .x86_64-linux-alpine
  variables:
    FLAVOUR: native

x86_64-linux-alpine-unreg:
  extends: .x86_64-linux-alpine
  variables:
    FLAVOUR: unreg

x86_64-linux-ubuntu:
  tags:
    - x86_64-linux
  image: registry.gitlab.haskell.org/ghc/ci-images/x86_64-linux-ubuntu20_04:$DOCKER_REV
  before_script:
    - |
      mkdir -p ~/.local
      curl -f -L --retry 5 https://nodejs.org/dist/v19.5.0/node-v19.5.0-linux-x64.tar.xz | tar xJ --strip-components=1 -C ~/.local
      export PATH=~/.local/bin:$PATH
    - sudo chown ghc:ghc -R .
  script:
    - |
      PREFIX=/tmp/.ghc-wasm ./setup.sh
      . /tmp/.ghc-wasm/env
    - |
      pushd "$(mktemp -d)"
      curl -f -L --retry 5 https://github.com/haskell/unix/archive/refs/heads/master.tar.gz | tar xz --strip-components=1
      cp /tmp/.ghc-wasm/wasi-sdk/share/misc/config.* .
      autoreconf -i
      wasm32-wasi-cabal --project-file=cabal.project.wasm32-wasi build
      ./test-wasm32-wasi.mjs
      popd

x86_64-linux-nix:
  tags:
    - x86_64-linux
  image: nixos/nix:2.13.2
  before_script:
    - echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
  script:
    - |
      nix build --json --no-link .
      nix build --json --no-link .#wasm32-wasi-ghc-native
      nix build --json --no-link .#wasm32-wasi-ghc-unreg
    - |
      pushd "$(mktemp -d)"
      curl -f -L --retry 5 https://github.com/tweag/ormolu/archive/refs/heads/master.tar.gz | tar xz --strip-components=1
      cd ormolu-live
      echo "allow-newer: template-haskell" > cabal.project.local
      nix shell $CI_PROJECT_DIR -c sh -c "wasm32-wasi-cabal update && ./build-wasm.sh"
      popd
