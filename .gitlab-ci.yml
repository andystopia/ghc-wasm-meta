variables:
  DOCKER_REV: afba24f3b3826c616b4d6236582152b43e6a51e6
  GIT_DEPTH: 1
  GIT_STRATEGY: clone

.x86_64-linux:
  tags:
    - x86_64-linux
  image: registry.gitlab.haskell.org/ghc/ci-images/x86_64-linux-alpine3_12:$DOCKER_REV
  before_script:
    - sudo chown ghc:ghc -R .
  script:
    - |
      PREFIX=/tmp/.ghc-wasm ./setup.sh
      . /tmp/.ghc-wasm/env

      pushd "$(mktemp -d)"
      echo "import System.Environment.Blank" >> hello.hs
      echo 'main = print =<< getArgs' >> hello.hs
      wasm32-wasi-ghc hello.hs -o hello.wasm
      $CROSS_EMULATOR ./hello.wasm "114 514" 233
      wasm-run ./hello.wasm "114 514" 233
      popd

x86_64-linux-gmp:
  extends: .x86_64-linux
  variables:
    FLAVOUR: gmp

x86_64-linux-native:
  extends: .x86_64-linux
  variables:
    FLAVOUR: native

x86_64-linux-unreg:
  extends: .x86_64-linux
  variables:
    FLAVOUR: unreg

x86_64-linux-nix:
  tags:
    - x86_64-linux
  image: nixos/nix:2.13.1
  before_script:
    - echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
  script:
    - |
      nix build --json --no-link .
      nix build --json --no-link .#wasm32-wasi-ghc-native
      nix build --json --no-link .#wasm32-wasi-ghc-unreg
